name: Update repo flake8 entry_points data

on:
  push:
    branches-ignore:
      # Because master will be scheduled
      - master
      - noaction-*
  schedule:
    - cron: '11 10 * * *'

defaults:
  run:
    shell: bash

jobs:
  update_f8eps:
    name: Update flake8 entry_points data
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v2

    - name: Install Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies & report
      run: ./10-install-dependencies

    - name: Clear build, rename/copy data
      run: ./20-prepare-files

    - name: Retrieve filtered package list
      run: ./30-retrieve-package-data

    - name: Generate the entry-points JSON and report
      run: ./40-generate-eps-json

    - name: Render the markdown
      run: |
        python write_content.py
        head -n20 mdbuild/*.md

    - name: Post tweets, if on master
      env:
        F8_TWITTER_KEY: ${{ secrets.F8_TWITTER_KEY }}
        F8_TWITTER_SECRET_KEY: ${{ secrets.F8_TWITTER_SECRET_KEY }}
        F8_TWITTER_TOKEN: ${{ secrets.F8_TWITTER_TOKEN }}
        F8_TWITTER_SECRET_TOKEN: ${{ secrets.F8_TWITTER_SECRET_TOKEN }}
      run: |
        BRANCH=$( git branch | grep '*' | sed -r 's/^\s*\*\s+(\S+)$/\1/' )
        if [[ $BRANCH = "master" ]]; then python create_tweets.py --post; else python create_tweets.py; fi

    - name: Cull old files
      run: rm data/*.old

    - name: Zip the JSON
      run: |
        cd data
        zip -m eps.json.zip eps*.json
        zip -m rss.json.zip rss.json

    - name: Report workspace git status
      run: |
        git status
        git branch -vv

    - name: Commit updated files back to repo
      run: |
        git config user.name "Brian Skinn"
        git config user.email "brian.skinn@gmail.com"
        ./repo_commit
