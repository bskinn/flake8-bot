name: Update repo flake8 entry_points data

on:
  push:
    branches-ignore:
      # Because master will be scheduled
      - master
      - noaction-*
  schedule:
    # Hourly cadence for initial testing
    - cron: '22 * * * *'

defaults:
  run:
    shell: bash

jobs:
  update_f8eps:
    name: Update flake8 entry_points data
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v2

    - name: Install Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies & report
      run: |
        python -m pip install -U pip
        pip install -r requirements.txt
        pip list

    - name: Clear data, build, etc.
      run: |
        rm -f data/*
        rm -f mdbuild/*

    - name: Retrieve filtered package list
      run: |
        python f8_list.py
        cat data/f8.list | tr '\n' '  '

    - name: Generate the entry-points JSON and report
      run: |
        ./generate_eps_json
        head -c80 data/*.json
        cat data/gen.log

    - name: Render the markdown
      run: |
        python write_content.py
        head -n20 mdbuild/*.md

    - name: Report workspace git status and store branch
      run: |
        git status
        git branch -vv

    - name: Commit updated files back to repo
      env:
        COMMIT_TOKEN: ${{ secrets.COMMIT_TOKEN }}
      run: |
        BRANCH=$( git branch | grep '*' | sed -r 's/^\s*\*\s+(\S+)$/\1/' )
        if [[ $BRANCH -eq master ]]; then git add .; fi
        if [[ $BRANCH -eq master ]]; then git commit -m "Update content - $( date )"; fi
        if [[ $BRANCH -eq master ]]; then git push https://bskinn:$COMMIT_TOKEN@github.com/bskinn/list-of-flake8-entrypoints; fi

